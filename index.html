<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Vault Simulator</title>
  <style>
    body { font-family: Arial, sans-serif; display: flex; margin: 0; padding: 0; }
    #leftColumn { flex: 3; padding: 20px; }
    #rightColumn { flex: 1; padding: 20px; border-left: 1px solid #ccc; background: #f9f9f9; }
    textarea { width: 100%; height: 120px; }
    button { margin: 10px 0; padding: 8px 14px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #bbb; padding: 6px; text-align: center; }
    .eliminated { background: #eee; color: #888; }
    #log { height: 140px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fcfcfc; }
    details { margin-top: 10px; }
    summary { font-weight: bold; cursor: pointer; }
    h3 { margin-top: 20px; }
  </style>
</head>
<body>

<div id="leftColumn">
  <h1>The Vault Simulator</h1>
  <textarea id="playerInput" placeholder="Enter 12 players, one per line"></textarea><br>
  <button id="startBtn" onclick="startGame()">Start Game</button>
  <button id="nextBtn" onclick="runRound()" style="display:none;">Next Round</button>

  <div id="log"></div>
  <div id="liveVotingMatrix"></div>
  <div id="progressTable"></div>
  <div id="votingChart"></div>
</div>

<div id="rightColumn">
  <details open>
    <summary>Alliances</summary>
    <div id="alliancesBox"></div>
  </details>
</div>

<script>
let players = [], alliances = {}, eliminated = [], finalists = [];
let phase = 1, round = 1, phase3Step = 0;
let lockpickHolder = null, lockpickUsed = false;
let phase3Duel = [];

function shuffle(array){ for (let i = array.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array;
}

function log(msg){ const logDiv = document.getElementById("log"); logDiv.innerHTML = msg + "<br>" + logDiv.innerHTML; }

function clearLog(){ document.getElementById("log").innerHTML = ""; }

function startGame(){
  const lines = document.getElementById("playerInput").value.trim().split("\n").map(s=>s.trim()).filter(s=>s);
  if(lines.length !== 12){ alert("Enter exactly 12 players."); return; }
  players = lines.map(n => ({ name: n, alliance: [], key1: false, key2: false, key3: false, totalKeys: 0, totalFinalKeys: 0, eliminated: false }));
  eliminated = []; finalists = []; phase = 1; round = 1; phase3Step = 0;
  lockpickHolder = null; lockpickUsed = false;
  assignAlliances();
  updateAlliancesBox();
  updateTable();
  clearLog();
  log("Game started with 12 players.");
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline";
  runRound();
}

function assignAlliances(){
  alliances = {};
  const shuffled = shuffle([...players]);
  for(let i=0; i<3; i++){
    alliances["Alliance "+(i+1)] = shuffled.slice(i*4, (i+1)*4).map(p => p.name);
  }
  players.forEach(p => {
    p.alliance = [];
    for(const [name, members] of Object.entries(alliances)){
      if(members.includes(p.name)) p.alliance.push(name);
    }
  });
}

function updateAlliancesBox(){
  let html = "";
  for(const [name, members] of Object.entries(alliances)){
    html += `<strong>${name}</strong><ul>`;
    members.forEach(m => html += `<li>${m}</li>`);
    html += `</ul>`;
  }
  document.getElementById("alliancesBox").innerHTML = html;
}
function updateTable(){
  let html = `<table><tr><th>Player</th><th>Phase 1</th><th>Phase 2</th><th>Phase 3</th><th>Total Keys</th></tr>`;
  players.forEach(p => {
    html += `<tr class="${p.eliminated ? 'eliminated' : ''}"><td>${p.name}</td><td>${p.key1 ? "✅" : ""}</td><td>${p.key2 ? "✅" : ""}</td><td>${p.key3 ? "✅" : ""}</td><td>${p.totalFinalKeys}</td></tr>`;
  });
  html += `</table>`;
  document.getElementById("progressTable").innerHTML = html;
}

function runRound(){
  clearLog();
  document.getElementById("liveVotingMatrix").innerHTML = "";
  log(`<strong>Phase ${phase}, Round ${round}</strong>`);
  
  if(phase === 1){
    runPhase1();
  } else if(phase === 2){
    runPhase2();
  } else if(phase === 3){
    runPhase3();
  } else {
    runFinale();
  }
  updateTable();
}

// Placeholder simulation logic — implement full challenge/vote/duel mechanics here as needed.
// For brevity, this part will simulate simplified rounds, key assignment, and transitions.

function runPhase1(){
  const noKey = players.filter(p => !p.key1 && !p.eliminated);
  const drawn = shuffle(noKey).slice(0, 4);
  let challengeWinner = drawn[Math.floor(Math.random()*drawn.length)];
  let voteWinner = drawn[Math.floor(Math.random()*drawn.length)];
  voteWinner.key1 = true;
  challengeWinner.key1 = true;
  voteWinner.totalFinalKeys++;
  challengeWinner.totalFinalKeys++;
  log(`${voteWinner.name} wins the vote and earns a Phase 1 key.`);
  log(`${challengeWinner.name} wins the challenge and earns a Phase 1 key.`);
  round++;
  if(round > 4){
    players.forEach(p => {
      if(!p.key1){ p.eliminated = true; eliminated.push(p); }
    });
    phase = 2; round = 1;
    log("Phase 1 complete. Moving to Phase 2.");
  }
}

// Placeholder for Phase 2 logic — similar structure as above.
// Implement voting, lockpick use, duels, etc.

function runPhase2(){
  const noKey = players.filter(p => !p.eliminated && !p.key2);
  if(noKey.length <= 4){ phase = 3; round = 1; log("Phase 2 complete. Moving to Phase 3."); return; }

  const voteWinner = shuffle(noKey)[0];
  const opponent = shuffle(noKey.filter(p => p !== voteWinner))[0];
  const duelWinner = Math.random() < 0.5 ? voteWinner : opponent;
  duelWinner.key2 = true;
  duelWinner.totalFinalKeys++;
  log(`${voteWinner.name} wins the vote and chooses ${opponent.name} for the duel.`);
  log(`${duelWinner.name} wins the duel and earns a Phase 2 key.`);
  round++;
}

// Placeholder for Phase 3 logic.

function runPhase3(){
  const remaining = players.filter(p => !p.eliminated && p.key1 && p.key2);
  if(phase3Step === 0){
    const voteWinner = shuffle(remaining)[0];
    const chosen = shuffle(remaining.filter(p => p !== voteWinner))[0];
    voteWinner.key3 = true;
    chosen.key3 = true;
    voteWinner.totalFinalKeys++;
    chosen.totalFinalKeys++;
    phase3Duel = remaining.filter(p => ![voteWinner.name, chosen.name].includes(p.name));
    log(`${voteWinner.name} wins the vote and chooses ${chosen.name} to join them in the finale.`);
    phase3Step = 1;
  } else {
    const duelWinner = phase3Duel[Math.floor(Math.random()*phase3Duel.length)];
    duelWinner.key3 = true;
    duelWinner.totalFinalKeys++;
    log(`${duelWinner.name} wins the final duel and joins the finale.`);
    players.forEach(p => {
      if(p.key3) finalists.push(p);
      else if(!p.eliminated) { p.eliminated = true; eliminated.push(p); }
    });
    phase = 4; round = 1;
    log("Phase 3 complete. Moving to the Finale.");
  }
}

function runFinale(){
  const vaults = [3, 7, 11, 15, 17, 22];
  shuffle(vaults);
  finalists.forEach((f, i) => { f.vault = vaults[i]; });
  log("Finalists choose their vaults:");
  finalists.forEach(f => log(`${f.name} chooses the ${f.vault}-key vault.`));

  // Jury distributes 16 keys
  let juryKeys = 16;
  while(juryKeys > 0){
    const recipient = finalists[Math.floor(Math.random()*finalists.length)];
    recipient.totalFinalKeys++;
    juryKeys--;
  }

  updateTable();
  log("Jury keys have been distributed.");

  let winner = null;
  for(const f of finalists){
    if(f.totalFinalKeys >= f.vault){
      if(!winner || f.vault > winner.vault){ winner = f; }
    }
  }

  if(winner){
    log(`<strong>${winner.name} opens their vault and wins the season!</strong>`);
  } else {
    const fallback = players.find(p => p.eliminated && p.key1 && p.key2);
    log(`No vault opened. <strong>${fallback.name}</strong> wins by default!`);
  }

  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("startBtn").style.display = "inline";
  document.getElementById("startBtn").innerText = "Simulate Again";
}
</script>

</body>
</html>