<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Vault Simulator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1300px;
      margin: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h2 {
      margin-top: 0;
    }
    .button-group {
      text-align: center;
      margin: 20px 0;
    }
    .button-group button {
      padding: 10px 20px;
      font-size: 16px;
    }
    .voting-table, .progress-table, .jury-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .voting-table th, .voting-table td,
    .progress-table th, .progress-table td,
    .jury-table th, .jury-table td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .round-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .collapsible {
      background-color: #eee;
      color: #333;
      cursor: pointer;
      padding: 8px;
      border: none;
      text-align: left;
      width: 100%;
      font-size: 14px;
      font-weight: bold;
      margin-top: 10px;
    }
    .collapsible:after {
      content: '\002B';
      float: right;
    }
    .collapsible.active:after {
      content: "\2212";
    }
    .content {
      padding: 0 15px;
      display: none;
      overflow: hidden;
      background-color: #f9f9f9;
      margin-bottom: 10px;
    }
    .key-slot {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 1px solid #ccc;
      margin: 0 2px;
      text-align: center;
      line-height: 20px;
    }
    .key-slot.filled {
      background-color: gold;
    }
    .grayed {
      color: #aaa;
    }
    select {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="left-box">
      <h2>Round Events</h2>
      <div id="log"></div>
      <div id="button-box" class="button-group">
        <button id="startBtn">Start Game</button>
      </div>
    </div>
    <div class="card" id="right-box">
      <h2>Alliances</h2>
      <div id="alliances"></div>
    </div>
  </div>

  <div class="container">
    <div class="card" style="grid-column: span 2;">
      <h2>Progress Chart</h2>
      <div id="progress"></div>
    </div>
  </div>

  <div class="container">
    <div class="card" style="grid-column: span 2;">
      <h2>Voting Matrix</h2>
      <div id="voteMatrix"></div>
    </div>
  </div>

  <div class="container">
    <div class="card" style="grid-column: span 2;">
      <h2>Jury Key Distribution</h2>
      <div id="juryMatrix"></div>
    </div>
  </div>

<script>
// ========== GLOBAL GAME STATE ==========
let players = [];
let alliances = {};
let activePlayers = [];
let eliminatedPlayers = [];
let jury = [];
let phase = 1;
let round = 1;
let maxRoundsPhase1 = 4;
let maxRoundsPhase2 = 4;
let lockpickHolder = null;
let lockpickUsed = false;
let hiddenLockpick = true;
let progress = {};
let keyHolders = { phase1: [], phase2: [], phase3: [], finalists: [] };
let currentVotingMatrix = '';
let final3 = [];
let vaultChoices = {};
let juryVotes = {};
let totalKeys = {};
let voteLog = [];
let logBox = document.getElementById("log");

// ========== HELPER FUNCTIONS ==========
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function createVotingMatrix(votes, eligible, voteeLabel) {
  let html = `<details><summary>Voting Matrix (Round ${round})</summary><table><tr><th>Voter</th><th>${voteeLabel}</th></tr>`;
  votes.forEach(v => {
    html += `<tr><td>${v.voter}</td><td>${v.vote}</td></tr>`;
  });
  html += "</table></details>";
  return html;
}

function logEvent(message) {
  logBox.innerHTML = message;
}

function clearLog() {
  logBox.innerHTML = '';
  document.getElementById("votingMatrix").innerHTML = '';
}

function renderProgressChart() {
  let chartHTML = `<table><tr><th>Player</th><th>Phase 1</th><th>Phase 2</th><th>Phase 3</th></tr>`;
  players.forEach(player => {
    const p1 = keyHolders.phase1.includes(player) ? '✅' : '⬜';
    const p2 = keyHolders.phase2.includes(player) ? '✅' : '⬜';
    const p3 = keyHolders.phase3.includes(player) ? '✅' : '⬜';
    chartHTML += `<tr><td>${player}</td><td>${p1}</td><td>${p2}</td><td>${p3}</td></tr>`;
  });
  chartHTML += '</table>';
  document.getElementById("progressChart").innerHTML = chartHTML;
}

function renderAlliances() {
  let allianceHTML = `<select><option>Show Alliances</option>`;
  for (const [name, members] of Object.entries(alliances)) {
    allianceHTML += `<option value="${name}">${name}: ${members.join(', ')}</option>`;
  }
  allianceHTML += `</select>`;
  document.getElementById("alliancesBox").innerHTML = allianceHTML;
}

// ========== GAME FLOW START ==========
function startGame() {
  const input = document.getElementById("playerInput").value.trim().split("\n").map(p => p.trim()).filter(Boolean);
  if (input.length !== 12) {
    alert("Please enter exactly 12 players.");
    return;
  }
  players = input;
  activePlayers = [...players];
  renderAlliances(); // generate fake alliances
  phase = 1;
  round = 1;
  logEvent("Game started with 12 players. Phase 1 begins!");
  document.getElementById("startBtn").style.display = 'none';
  document.getElementById("nextBtn").style.display = 'inline';
  document.getElementById("simulateBtn").style.display = 'none';
  renderProgressChart();
}

// ========== PHASE 1: KEY QUEST ==========
function phase1Round() {
  if (round > maxRoundsPhase1) {
    logEvent("Phase 1 complete.");
    phase = 2;
    round = 1;
    activePlayers = players.filter(p => keyHolders.phase1.includes(p));
    eliminatedPlayers = players.filter(p => !keyHolders.phase1.includes(p));
    jury = [...eliminatedPlayers];
    return;
  }

  let eligible = players.filter(p => !keyHolders.phase1.includes(p));
  shuffle(eligible);
  let drawn = eligible.slice(0, 4);
  let voteTarget = drawn[Math.floor(Math.random() * drawn.length)];
  let votes = players.map(voter => ({ voter, vote: voteTarget }));
  keyHolders.phase1.push(voteTarget);
  let challengeWinner = drawn.find(p => p !== voteTarget);
  if (challengeWinner) keyHolders.phase1.push(challengeWinner);
  logEvent(`Phase 1 - Round ${round}: ${voteTarget} won the vote. ${challengeWinner} won the challenge.`);
  document.getElementById("votingMatrix").innerHTML = createVotingMatrix(votes, drawn, "Voted For");
  round++;
  renderProgressChart();
}

// ========== PHASE 2: KEY DUEL ==========
function phase2Round() {
  if (round > maxRoundsPhase2) {
    logEvent("Phase 2 complete.");
    phase = 3;
    round = 1;
    let stillNoKey = activePlayers.filter(p => !keyHolders.phase2.includes(p));
    eliminatedPlayers.push(...stillNoKey);
    jury.push(...stillNoKey);
    activePlayers = activePlayers.filter(p => keyHolders.phase2.includes(p));
    return;
  }

  let noKey = activePlayers.filter(p => !keyHolders.phase2.includes(p));
  if (noKey.length < 2) {
    round++;
    return;
  }

  let voteTarget = noKey[Math.floor(Math.random() * noKey.length)];
  let opponent = noKey.find(p => p !== voteTarget) || voteTarget;
  let votes = activePlayers.map(voter => ({ voter, vote: voteTarget }));

  let winner = Math.random() < 0.5 ? voteTarget : opponent;
  keyHolders.phase2.push(winner);
  logEvent(`Phase 2 - Round ${round}: ${voteTarget} dueled ${opponent}. ${winner} won the key.`);
  document.getElementById("votingMatrix").innerHTML = createVotingMatrix(votes, noKey, "Voted For");
  round++;
  renderProgressChart();
}

// ========== PHASE 3: FINAL CUT ==========
function phase3Round() {
  if (round === 1) {
    let voteWinner = activePlayers[Math.floor(Math.random() * activePlayers.length)];
    let choice = activePlayers.find(p => p !== voteWinner);
    keyHolders.phase3.push(voteWinner, choice);
    final3 = [voteWinner, choice];
    logEvent(`Phase 3 Vote: ${voteWinner} wins and brings ${choice} to finale.`);
    round++;
  } else {
    let remaining = activePlayers.filter(p => !final3.includes(p));
    let duelWinner = remaining[Math.floor(Math.random() * remaining.length)];
    final3.push(duelWinner);
    let eliminated = remaining.find(p => p !== duelWinner);
    eliminatedPlayers.push(eliminated);
    jury.push(eliminated);
    keyHolders.phase3.push(duelWinner);
    logEvent(`${duelWinner} wins the final duel and joins the finale. ${eliminated} is eliminated.`);
    renderProgressChart();
    phase = 4;
  }
}

// ========== PHASE 4: VAULT FINALE ==========
function vaultFinale() {
  final3.forEach(p => totalKeys[p] = 3);

  jury.forEach(juror => {
    let keysToGive = eliminatedPlayers.includes(juror) ? 2 : 1;
    let giveTo = final3[Math.floor(Math.random() * final3.length)];
    totalKeys[giveTo] += keysToGive;
  });

  let winner = final3.reduce((a, b) => totalKeys[a] > totalKeys[b] ? a : b);
  logEvent(`Vault Finale: ${winner} wins with ${totalKeys[winner]} keys!`);
  document.getElementById("simulateBtn").style.display = 'inline';
  document.getElementById("nextBtn").style.display = 'none';
}

// ========== MAIN BUTTON DRIVER ==========
function nextRound() {
  clearLog();
  if (phase === 1) {
    phase1Round();
  } else if (phase === 2) {
    phase2Round();
  } else if (phase === 3) {
    phase3Round();
  } else if (phase === 4) {
    vaultFinale();
  }
}

// ========== RESET ==========
function resetGame() {
  players = [];
  alliances = {};
  activePlayers = [];
  eliminatedPlayers = [];
  jury = [];
  phase = 1;
  round = 1;
  lockpickHolder = null;
  lockpickUsed = false;
  hiddenLockpick = true;
  keyHolders = { phase1: [], phase2: [], phase3: [], finalists: [] };
  totalKeys = {};
  final3 = [];
  document.getElementById("startBtn").style.display = 'inline';
  document.getElementById("nextBtn").style.display = 'none';
  document.getElementById("simulateBtn").style.display = 'none';
  document.getElementById("progressChart").innerHTML = '';
  document.getElementById("votingMatrix").innerHTML = '';
  logBox.innerHTML = '';
}
</script>
</body>
</html>