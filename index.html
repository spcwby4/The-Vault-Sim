<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Vault Simulator</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f8f8; }
    h1, h2 { margin-top: 0; }
    #playerInput, #startGame, #nextRound, #simulateAgain { margin-bottom: 15px; }
    #log, #votingMatrixContainer, #juryKeyMatrix { background: white; padding: 15px; border: 1px solid #ccc; margin-top: 15px; max-height: 300px; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    .key-slot { font-size: 1.2em; }
    .key-earned { color: green; font-weight: bold; }
    .key-missed { color: red; }
    .collapsible { cursor: pointer; background-color: #eee; padding: 10px; border: none; width: 100%; text-align: left; font-weight: bold; }
    .content { display: none; overflow: hidden; background-color: #f1f1f1; }
    #allianceBox { float: right; width: 30%; background: white; padding: 10px; border: 1px solid #ccc; }
    #eventBox { float: left; width: 65%; }
    #charts { clear: both; padding-top: 20px; }
  </style>
</head>
<body>
  <h1>The Vault Simulator</h1>
  <textarea id="playerInput" rows="12" cols="30" placeholder="Enter one player name per line"></textarea><br />
  <button id="startGame">Start Game</button>
  <button id="nextRound" style="display:none;">Next Round</button>
  <button id="simulateAgain" style="display:none;">Simulate Again</button>

  <div id="eventBox">
    <div id="log"><strong>Game Log:</strong><br /></div>
    <div id="votingMatrixContainer"></div>
    <div id="juryKeyMatrix"></div>
  </div>

  <div id="allianceBox"><strong>Alliances:</strong><div id="alliancesContent"></div></div>

  <div id="charts">
    <h2>Progress Chart</h2>
    <div id="progressChart"></div>
  </div>

  <script>
// === FULL JAVASCRIPT FOR THE VAULT SIMULATOR ===

let players = [];
let currentPhase = 1;
let round = 0;
let activePlayers = [];
let eliminatedPlayers = [];
let keyHolders = {};
let alliances = {};
let lockpickHolder = null;
let lockpickUsed = false;
let juryKeys = [];
let phase3Finalists = [];
let log = document.getElementById("log");
let matrixContainer = document.getElementById("votingMatrixContainer");
let juryMatrix = document.getElementById("juryKeyMatrix");
let progressChart = document.getElementById("progressChart");

document.getElementById("startGame").onclick = () => {
  players = document.getElementById("playerInput").value.trim().split("\n").map(p => p.trim()).filter(p => p);
  if (players.length !== 12) {
    alert("You must enter exactly 12 player names.");
    return;
  }
  startGame();
};

document.getElementById("simulateAgain").onclick = () => location.reload();

function startGame() {
  document.getElementById("startGame").style.display = "none";
  document.getElementById("playerInput").style.display = "none";
  document.getElementById("nextRound").style.display = "inline";
  activePlayers = [...players];
  round = 0;
  currentPhase = 1;
  keyHolders = {};
  eliminatedPlayers = [];
  lockpickHolder = null;
  lockpickUsed = false;
  alliances = generateAlliances(players);
  updateAllianceBox();
  updateProgressChart();
  log.innerHTML = "<strong>Game Log:</strong><br />Phase 1 begins!";
  nextRound();
}

document.getElementById("nextRound").onclick = () => {
  if (currentPhase === 1) playPhase1Round();
  else if (currentPhase === 2) playPhase2Round();
  else if (currentPhase === 3) playPhase3Round();
  else if (currentPhase === 4) playFinale();
};

function playPhase1Round() {
  if (round >= 4) {
    endPhase1();
    return;
  }

  round++;
  log.innerHTML = `<strong>Game Log:</strong><br />Phase 1 – Round ${round}<br />`;
  matrixContainer.innerHTML = '';
  const drawn = drawPlayers(4, p => !keyHolders[p]);
  const voteWinner = simulateVote(activePlayers, drawn);
  const challengeWinner = drawn[Math.floor(Math.random() * drawn.length)];
  if (!keyHolders[voteWinner]) keyHolders[voteWinner] = [];
  if (!keyHolders[challengeWinner]) keyHolders[challengeWinner] = [];

  keyHolders[voteWinner].push(`P1-R${round} (vote)`);
  keyHolders[challengeWinner].push(`P1-R${round} (challenge)`);
  updateProgressChart();

  log.innerHTML += `Players drawn: ${drawn.join(", ")}<br />`;
  log.innerHTML += `Vote winner: ${voteWinner}<br />Challenge winner: ${challengeWinner}<br />`;

  showVoteMatrix(activePlayers, drawn, voteWinner);
}

function endPhase1() {
  currentPhase = 2;
  round = 0;
  eliminatedPlayers = players.filter(p => !keyHolders[p]);
  activePlayers = players.filter(p => keyHolders[p]);
  log.innerHTML = "<strong>Game Log:</strong><br />Phase 1 complete.<br />Eliminated: " + eliminatedPlayers.join(", ");
  updateProgressChart();
}

function playPhase2Round() {
  if (round >= 4) {
    endPhase2();
    return;
  }

  round++;
  log.innerHTML = `<strong>Game Log:</strong><br />Phase 2 – Round ${round}<br />`;
  matrixContainer.innerHTML = '';

  const noKeyPlayers = activePlayers.filter(p => !hasPhaseKey(p, 2));
  const voteWinner = simulateVote(activePlayers, noKeyPlayers);
  const opponent = noKeyPlayers.filter(p => p !== voteWinner)[Math.floor(Math.random() * (noKeyPlayers.length - 1))];
  const duelWinner = Math.random() < 0.5 ? voteWinner : opponent;
  if (!keyHolders[duelWinner]) keyHolders[duelWinner] = [];
  keyHolders[duelWinner].push(`P2-R${round} (duel)`);
  log.innerHTML += `No-key players: ${noKeyPlayers.join(", ")}<br />`;
  log.innerHTML += `Vote winner: ${voteWinner}<br />Duel opponent: ${opponent}<br />Duel winner: ${duelWinner}<br />`;

  updateProgressChart();
  showVoteMatrix(activePlayers, noKeyPlayers, voteWinner);
}

function endPhase2() {
  currentPhase = 3;
  round = 0;
  eliminatedPlayers.push(...activePlayers.filter(p => !hasPhaseKey(p, 2)));
  activePlayers = activePlayers.filter(p => hasPhaseKey(p, 2));
  log.innerHTML = "<strong>Game Log:</strong><br />Phase 2 complete.<br />Eliminated: " + eliminatedPlayers.join(", ");
  updateProgressChart();
}

function playPhase3Round() {
  if (round === 0) {
    round = 1;
    const voteWinner = simulateVote(activePlayers, activePlayers);
    const chosen = activePlayers.filter(p => p !== voteWinner)[Math.floor(Math.random() * 2)];
    const others = activePlayers.filter(p => p !== voteWinner && p !== chosen);
    const challengeWinner = others[Math.floor(Math.random() * 2)];
    phase3Finalists = [voteWinner, chosen, challengeWinner];
    eliminatedPlayers.push(...others.filter(p => p !== challengeWinner));
    log.innerHTML = `<strong>Game Log:</strong><br />Phase 3 Vote<br />Vote winner: ${voteWinner}<br />Vote winner brings: ${chosen}<br />Challenge winner: ${challengeWinner}<br />`;
    updateProgressChart();
    showVoteMatrix(activePlayers, activePlayers, voteWinner);
  } else {
    currentPhase = 4;
    round = 0;
    log.innerHTML += "Moving to Finale...";
  }
}

function playFinale() {
  log.innerHTML = "<strong>Finale:</strong><br />";
  const baseKeys = {};
  phase3Finalists.forEach(p => baseKeys[p] = 3);

  let totalKeys = { ...baseKeys };
  eliminatedPlayers.forEach((juror, idx) => {
    const count = idx < 4 ? 1 : (idx < 8 ? 2 : 4);
    for (let i = 0; i < count; i++) {
      const recipient = phase3Finalists[Math.floor(Math.random() * 3)];
      totalKeys[recipient]++;
    }
  });

  const vaults = [12, 17, 22].sort(() => Math.random() - 0.5);
  let winner = null;
  for (let i = 2; i >= 0; i--) {
    if (totalKeys[phase3Finalists[i]] >= vaults[i]) {
      winner = phase3Finalists[i];
      break;
    }
  }

  log.innerHTML += `Vaults: ${vaults.join(", ")}<br />`;
  phase3Finalists.forEach(p => {
    log.innerHTML += `${p} - Keys: ${totalKeys[p]} - Vault Needed: ${vaults[phase3Finalists.indexOf(p)]}<br />`;
  });
  log.innerHTML += `<strong>Winner: ${winner || "4th place player (no vault opened)"}</strong>`;
  document.getElementById("nextRound").style.display = "none";
  document.getElementById("simulateAgain").style.display = "inline";
}

function drawPlayers(n, filterFn) {
  const pool = players.filter(filterFn);
  let drawn = [];
  while (drawn.length < n) {
    let pick = pool[Math.floor(Math.random() * pool.length)];
    if (!drawn.includes(pick)) drawn.push(pick);
  }
  return drawn;
}

function simulateVote(voters, candidates) {
  const votes = {};
  voters.forEach(voter => {
    const possible = candidates.filter(c => c !== voter);
    const vote = possible[Math.floor(Math.random() * possible.length)];
    votes[vote] = (votes[vote] || 0) + 1;
  });
  let maxVotes = 0;
  let winner = null;
  for (let p in votes) {
    if (votes[p] > maxVotes) {
      maxVotes = votes[p];
      winner = p;
    }
  }
  return winner;
}

function showVoteMatrix(voters, candidates, winner) {
  const btn = document.createElement("button");
  btn.className = "collapsible";
  btn.innerText = "Show Voting Matrix";
  const content = document.createElement("div");
  content.className = "content";
  let html = "<table><tr><th>Voter</th><th>Voted For</th></tr>";
  voters.forEach(voter => {
    const possible = candidates.filter(c => c !== voter);
    const vote = possible[Math.floor(Math.random() * possible.length)];
    html += `<tr><td>${voter}</td><td>${vote}</td></tr>`;
  });
  html += "</table>";
  content.innerHTML = html;

  btn.onclick = function () {
    this.classList.toggle("active");
    content.style.display = content.style.display === "block" ? "none" : "block";
  };

  matrixContainer.innerHTML = '';
  matrixContainer.appendChild(btn);
  matrixContainer.appendChild(content);
}

function generateAlliances(players) {
  const a1 = players.slice(0, 4);
  const a2 = players.slice(4, 8);
  const a3 = players.slice(8, 12);
  return {
    "Alliance A": a1,
    "Alliance B": a2,
    "Alliance C": a3
  };
}

function updateAllianceBox() {
  const container = document.getElementById("alliancesContent");
  container.innerHTML = "";
  for (const name in alliances) {
    container.innerHTML += `<strong>${name}</strong>: ${alliances[name].join(", ")}<br />`;
  }
}

function updateProgressChart() {
  let html = "<table><tr><th>Player</th><th>Phase 1</th><th>Phase 2</th><th>Phase 3</th></tr>";
  players.forEach(p => {
    const keys = keyHolders[p] || [];
    const p1 = keys.filter(k => k.includes("P1")).length;
    const p2 = keys.filter(k => k.includes("P2")).length;
    const p3 = phase3Finalists.includes(p) ? 1 : 0;
    html += `<tr><td>${p}</td><td>${getKeyVisual(p1)}</td><td>${getKeyVisual(p2)}</td><td>${getKeyVisual(p3)}</td></tr>`;
  });
  html += "</table>";
  progressChart.innerHTML = html;
}

function getKeyVisual(count) {
  let icons = "";
  for (let i = 0; i < 3; i++) {
    if (i < count) icons += '<span class="key-slot key-earned">✅</span>';
    else icons += '<span class="key-slot key-missed">❌</span>';
  }
  return icons;
}
  </script>
</body>
</html>