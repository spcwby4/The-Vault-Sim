<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Vault Simulator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 20px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    textarea, button {
      width: 100%;
      margin-top: 10px;
      font-size: 16px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .key-cell {
      font-weight: bold;
    }
    .highlight {
      background-color: #dff0d8;
    }
  </style>
</head>
<body>
  <h1>The Vault Simulator</h1>
  <div class="container">
    <div>
      <div class="card">
        <h2>Enter 12 Player Names (1 per line)</h2>
        <textarea id="playerInput" rows="13" placeholder="Enter 12 players..."></textarea>
        <button onclick="startGame()">Start Game</button>
        <button onclick="nextRound()" style="display:none" id="nextBtn">Next Round</button>
      </div>

      <div class="card" id="eventLogBox">
        <h2>Round Events</h2>
        <div id="eventLog" style="white-space: pre-line;"></div>
      </div>

      <div class="card" id="votingMatrixBox" style="display:none">
        <h2>Voting Matrix</h2>
        <div id="votingMatrix"></div>
      </div>

      <div class="card" id="juryMatrixBox" style="display:none">
        <h2>Jury Key Matrix</h2>
        <div id="juryMatrix"></div>
      </div>

      <div class="card" id="progressChartBox" style="display:none">
        <h2>Progress Chart</h2>
        <div id="progressChart"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>Alliances</h2>
        <div id="alliancesDisplay"></div>
      </div>
    </div>
  </div>

  <script>
// === VAULT SIMULATOR FULL GAME LOGIC ===

let players = [];
let round = 1;
let phase = 1;
let activePlayers = [];
let eliminatedPlayers = [];
let jurors = [];
let finalists = [];
let lockpickHolder = null;
let lockpickHidden = true;
let alliances = [];
let progressChart = {};
let roundLog = "";
let voteMatrix = [];
let juryKeys = {};
let vaultChoices = {};
let vaults = [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
let nextBtn;

function startGame() {
  const input = document.getElementById("playerInput").value.trim().split("\n").map(p => p.trim()).filter(Boolean);
  if (input.length !== 12) {
    alert("You must enter exactly 12 players.");
    return;
  }
  players = input.map(name => ({
    name,
    keys: 0,
    eliminated: false,
    alliances: [],
    phase: null
  }));
  activePlayers = [...players];
  generateAlliances();
  displayAlliances();
  document.getElementById("playerInput").style.display = "none";
  document.querySelector("textarea").style.display = "none";
  document.querySelector("button").style.display = "none";
  nextBtn = document.getElementById("nextBtn");
  nextBtn.style.display = "block";
  nextBtn.textContent = "Next Round";
  logEvent("Phase 1: Key Quest begins!");
  displayProgressChart();
}

function generateAlliances() {
  const a1 = players.slice(0, 4);
  const a2 = players.slice(4, 8);
  const a3 = players.slice(8, 12);
  alliances = [
    { name: "Alliance Alpha", members: a1 },
    { name: "Alliance Bravo", members: a2 },
    { name: "Alliance Chaos", members: a3 }
  ];
  for (const alliance of alliances) {
    for (const player of alliance.members) {
      player.alliances.push(alliance.name);
    }
  }
}

function displayAlliances() {
  const box = document.getElementById("alliancesDisplay");
  box.innerHTML = "";
  alliances.forEach(alliance => {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${alliance.name}:</strong> ${alliance.members.map(p => p.name).join(", ")}`;
    box.appendChild(div);
  });
}

function nextRound() {
  clearLog();
  switch (phase) {
    case 1:
      simulatePhase1();
      break;
    case 2:
      simulatePhase2();
      break;
    case 3:
      simulatePhase3();
      break;
    case 4:
      simulateFinale();
      break;
  }
}

function simulatePhase1() {
  logEvent(`Phase 1 - Round ${round}`);
  const eligible = activePlayers.filter(p => p.keys === 0);
  if (eligible.length <= 4 && round === 4) {
    logEvent(`Final Round: All players without keys are drawn.`);
  }
  const drawn = randomSample(eligible, 4);
  drawn.forEach(p => logEvent(`${p.name} is drawn.`));
  if (lockpickHidden && Math.random() < 0.33) {
    const finder = drawn[Math.floor(Math.random() * drawn.length)];
    lockpickHolder = finder;
    lockpickHidden = false;
    logEvent(`${finder.name} secretly found the Lockpick.`);
  }

  const voteWinner = randomPick(drawn);
  if (lockpickHolder && drawn.includes(lockpickHolder) && Math.random() < 0.7) {
    logEvent(`${lockpickHolder.name} uses the Lockpick to win the vote key!`);
    voteWinner = lockpickHolder;
    lockpickHolder = null;
    lockpickHidden = true;
  }
  voteWinner.keys += 1;
  voteWinner.phase = 1;
  logEvent(`${voteWinner.name} wins the vote key!`);

  const remaining = drawn.filter(p => p !== voteWinner);
  const challengeWinner = randomPick(remaining);
  challengeWinner.keys += 1;
  challengeWinner.phase = 1;
  logEvent(`${challengeWinner.name} wins the challenge key!`);

  round++;
  updateProgressChart();

  if (round > 4) {
    const eliminated = activePlayers.filter(p => p.keys === 0);
    eliminated.forEach(p => {
      p.eliminated = true;
      eliminatedPlayers.push(p);
      jurors.push(p);
      logEvent(`${p.name} is eliminated in Phase 1.`);
    });
    activePlayers = activePlayers.filter(p => p.keys > 0);
    phase = 2;
    round = 1;
    logEvent(`Phase 2: Key Duels begins!`);
  }
}

function simulatePhase2() {
  logEvent(`Phase 2 - Round ${round}`);
  const noKeyPlayers = activePlayers.filter(p => p.phase !== 2);
  if (noKeyPlayers.length < 2) {
    logEvent(`Only one player remains without a key. Auto-advancing to Phase 3.`);
    phase = 3;
    round = 1;
    return;
  }

  if (lockpickHidden && Math.random() < 0.33) {
    const finder = randomPick(noKeyPlayers);
    lockpickHolder = finder;
    lockpickHidden = false;
    logEvent(`${finder.name} secretly found the Lockpick.`);
  }

  let voteWinner;
  if (lockpickHolder && noKeyPlayers.includes(lockpickHolder) && Math.random() < 0.7) {
    voteWinner = lockpickHolder;
    logEvent(`${voteWinner.name} uses the Lockpick to win the vote!`);
    lockpickHolder = null;
    lockpickHidden = true;
  } else {
    voteWinner = randomPick(noKeyPlayers);
  }

  const duelOpponent = randomPick(noKeyPlayers.filter(p => p !== voteWinner));
  logEvent(`${voteWinner.name} chooses to duel ${duelOpponent.name}.`);

  const winner = Math.random() < 0.5 ? voteWinner : duelOpponent;
  winner.keys += 1;
  winner.phase = 2;
  logEvent(`${winner.name} wins the duel and earns a key!`);

  round++;
  updateProgressChart();

  if (round > 4) {
    const eliminated = activePlayers.filter(p => p.phase !== 2);
    eliminated.forEach(p => {
      p.eliminated = true;
      eliminatedPlayers.push(p);
      jurors.push(p);
      logEvent(`${p.name} is eliminated in Phase 2.`);
    });
    activePlayers = activePlayers.filter(p => p.phase === 2);
    phase = 3;
    round = 1;
    logEvent(`Phase 3: Final Cut begins!`);
  }
}

function simulatePhase3() {
  logEvent(`Phase 3: Final 4`);
  const voteWinner = randomPick(activePlayers);
  logEvent(`${voteWinner.name} wins the Phase 3 vote and advances to the finale.`);

  const choice = randomPick(activePlayers.filter(p => p !== voteWinner));
  logEvent(`${voteWinner.name} brings ${choice.name} with them to the finale.`);

  const remaining = activePlayers.filter(p => ![voteWinner.name, choice.name].includes(p.name));
  const challengeWinner = Math.random() < 0.5 ? remaining[0] : remaining[1];
  logEvent(`${remaining[0].name} and ${remaining[1].name} face off in a challenge...`);
  logEvent(`${challengeWinner.name} wins and joins the finale.`);

  const fourthPlace = remaining.find(p => p !== challengeWinner);
  fourthPlace.eliminated = true;
  eliminatedPlayers.push(fourthPlace);
  jurors.push(fourthPlace);
  logEvent(`${fourthPlace.name} is eliminated in 4th place.`);

  finalists = [voteWinner, choice, challengeWinner];
  finalists.forEach(p => {
    p.keys += 1;
    p.phase = 3;
  });
  updateProgressChart();
  phase = 4;
}

function simulateFinale() {
  logEvent(`Vault Finale Begins!`);
  const matrix = {};
  jurors.forEach(j => {
    const count = j.phase === 1 ? 1 : j.phase === 2 ? 2 : 4;
    const recipients = randomSample(finalists, Math.min(count, finalists.length));
    matrix[j.name] = {};
    recipients.forEach(r => {
      if (!matrix[j.name][r.name]) matrix[j.name][r.name] = 0;
      matrix[j.name][r.name]++;
      r.keys++;
    });
  });
  displayJuryMatrix(matrix);

  finalists.forEach(f => {
    let vaultGuess = 10 + Math.floor(Math.random() * 5);
    if (f.keys >= 13) vaultGuess += 2;
    vaultChoices[f.name] = vaults.filter(v => v <= f.keys).reverse()[0] || 3;
  });

  let opener = null;
  let highest = 0;
  for (const f of finalists) {
    const vault = vaultChoices[f.name];
    if (f.keys >= vault && vault > highest) {
      opener = f;
      highest = vault;
    }
  }
  if (opener) {
    logEvent(`${opener.name} opens the ${highest}-key vault and wins The Vault!`);
  } else {
    const fallback = eliminatedPlayers.find(p => p.phase === 3);
    logEvent(`No one opened a vault. ${fallback.name} wins The Vault by default.`);
  }
  nextBtn.textContent = "Simulate Again";
  nextBtn.onclick = () => location.reload();
}

function logEvent(msg) {
  const log = document.getElementById("eventLog");
  log.innerText += msg + "\n";
}

function clearLog() {
  document.getElementById("eventLog").innerText = "";
}

function updateProgressChart() {
  const chart = document.getElementById("progressChart");
  chart.innerHTML = "";
  const header = document.createElement("table");
  let hRow = "<tr><th>Player</th><th>Phase 1</th><th>Phase 2</th><th>Phase 3</th></tr>";
  header.innerHTML = hRow;
  chart.appendChild(header);

  players.forEach(p => {
    const row = document.createElement("tr");
    const p1 = p.phase === 1 || p.phase === 2 || p.phase === 3 ? "✅" : "";
    const p2 = p.phase === 2 || p.phase === 3 ? "✅" : "";
    const p3 = p.phase === 3 ? "✅" : "";
    row.innerHTML = `<td>${p.name}</td><td>${p1}</td><td>${p2}</td><td>${p3}</td>`;
    chart.appendChild(row);
  });

  document.getElementById("progressChartBox").style.display = "block";
}

function displayJuryMatrix(matrix) {
  const box = document.getElementById("juryMatrix");
  box.innerHTML = "";
  const table = document.createElement("table");
  let header = "<tr><th>Juror</th>";
  finalists.forEach(f => {
    header += `<th>${f.name}</th>`;
  });
  header += "</tr>";
  table.innerHTML += header;

  for (const juror in matrix) {
    let row = `<tr><td>${juror}</td>`;
    finalists.forEach(f => {
      const val = matrix[juror][f.name] || "";
      row += `<td>${val}</td>`;
    });
    row += "</tr>";
    table.innerHTML += row;
  }

  box.appendChild(table);
  document.getElementById("juryMatrixBox").style.display = "block";
}

// Utility
function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function randomSample(arr, n) {
  const copy = [...arr];
  const res = [];
  while (res.length < n && copy.length) {
    const idx = Math.floor(Math.random() * copy.length);
    res.push(copy.splice(idx, 1)[0]);
  }
  return res;
}
  </script>
</body>
</html>